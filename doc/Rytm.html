<!DOCTYPE html><html lang="en"><head><title>Rytm</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="Rytm"><meta name="groc-project-path" content="Rytm.js"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path">Rytm.js</div></div><div id="document"><div class="segment"></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="rytm">Rytm</h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Rytm is a asynchronous flow control library that turns nested chaos into linear, readable
sweetness.</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="the-reasons-for-rytm">The Reasons for Rytm</h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Says we are going to:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>Wait for user input.</li>
<li>Send user input to server, and wait for response.</li>
<li>Slide down the message box and in the meantime, fade in an image.</li>
<li>After above animation done, fade in the message which retrieved in step #2.</li>
</ol></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>To get above jobs done, inexperienced JavaScript developer usually generate code like
this:</p>

<pre><code>// hook on the input event and waiting for 'enter'
txtUserInput.bind('input', function(evt){
    if (evt.keyCode == 13){

        // post the user input to server and wait for response.
        $.post('/api', txtUserInput.val(), function(data){

            var msg = data.message, animationCount = 0;

            divMsgBox.slideDown(function(){
                animationCount++
                checkIfAnimationDone();
            })

            imgBanner.fadeIn(function(){
                animationCount++
                checkIfAnimationDone();
            })

            function checkIfAnimationDone(){
                if (animationCount &gt;= 2){
                    divMsgInner.html(msg).fadeIn();
                }
            }
        }
        });
    }
});
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>This is a really common task in asynchronous programming world but the code result doesn't 
look good enough:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>Too many nested blocks reduced your code readibility.</li>
<li>Hard to understand the logic, you need to trace the block by block to see what happened 
eventually.</li>
<li>Error prone.</li>
<li>The last fade-in animation must be done after the first 2 animation, writing code to check 
task status is tedious and waste of your time.</li>
</ol></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>By using a flow control library such as Rytm, writing code snippet for above task can be much
safer, simpler, and productivity, and the code become more readable and compact:</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><pre><code>var r = new Rytm(function(){

    txtUserInput.bind('input', this.next())

}, function(evt){

   if (evt.keyCode == 13){
       // tell Rytm to go to next step directly   
       return true;
   }

}, function(){

   $.postMessage('/api', txtUserInput.val(), this.go);

}, function(data){

   // pass the data to next beat
   this.nextArgs(data);
   // or :
   // this.next(this.next.bind(this, data));

   divMsgBox.slideDown(this.all());
   imgBanner.fadeIn(this.all());

 }, function(data){

    divMsgInner.html(data.msg).fadeIn();

 })
 .go();
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="multiple-environment-support">Multiple environment support</h1>

<p>Rytm supports multiply JavaScript environment including:</p></div></div><div class="code"><div class="wrapper"><span class="p">;(</span><span class="kd">function</span><span class="p">(</span><span class="nx">factory</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">Rytm</span> <span class="o">=</span> <span class="nx">factory</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">require</span><span class="p">){</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">require</span><span class="p">.</span><span class="nx">amd</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">define</span><span class="p">){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ul>
<li>AMD loader such as requirejs or curl: 
<code>require('path/to/rytm', callback);</code></li>
</ul></div></div><div class="code"><div class="wrapper">            <span class="k">this</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="nx">Rytm</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">exports</span><span class="p">){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ul>
<li>Nodejs module loading:
<code>var rytm = require('path/to/rytm');</code></li>
</ul></div></div><div class="code"><div class="wrapper">            <span class="k">this</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Rytm</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="p">})</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="internal-and-external-apis">Internal and External APIs</h1></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">global</span><span class="p">,</span> <span class="nx">undef</span><span class="p">){</span>
    <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>

    <span class="cm">/* no operation func */</span>
    <span class="kd">var</span> <span class="nx">noop</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">etui</span><span class="p">){</span>
        <span class="nx">noop</span> <span class="o">=</span> <span class="nx">global</span><span class="p">.</span><span class="nx">etui</span><span class="p">.</span><span class="nx">noop</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">jQuery</span><span class="p">){</span>
        <span class="nx">noop</span> <span class="o">=</span> <span class="nx">global</span><span class="p">.</span><span class="nx">jQuery</span><span class="p">.</span><span class="nx">noop</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span><span class="p">{</span>
        <span class="nx">noop</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){};</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="constructor">Constructor</h2>

<p>Create Rytm instance and also loads the tasks</p>

<p><code>var r = new Rytm(beat1, beat2, beat3 ... )</code></p>

<h3 id="parameters">Parameters</h3>

<ul>
<li>beat1-n: Tasks/callbacks which to be executed in order</li>
</ul>

<h3 id="tips-and-annotations">Tips and Annotations</h3>

<ul>
<li>Tasks can also be added later by calling <code>instance.beat</code></li>
</ul></div></div><div class="code"><div class="wrapper">    <span class="cm">/* </span>
<span class="cm">        Constructor</span>
<span class="cm">    */</span>
    <span class="kd">var</span> <span class="nx">Rytm</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ul>
<li>You can also create new instance the 'creator' style:
<code>var r = Rytm()</code></li>
</ul></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="k">this</span> <span class="k">instanceof</span> <span class="nx">Rytm</span><span class="p">){</span>
            <span class="k">return</span> <span class="k">new</span> <span class="p">(</span><span class="nx">Rytm</span><span class="p">.</span><span class="nx">bind</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">Rytm</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">))();</span>
        <span class="p">}</span>
    
        <span class="k">this</span><span class="p">.</span><span class="nx">steps</span> <span class="o">=</span> <span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">_createNode</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
        <span class="p">})];</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">cursor</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">steps</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ul>
<li>Wrap <code>go()</code>, make sure the context of <code>go()</code> is always current
instance</li>
</ul></div></div><div class="code"><div class="wrapper">        <span class="k">this</span><span class="p">.</span><span class="nx">go</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_go</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">defer</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">defer</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">wait</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">wait</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ul>
<li>Constructor will automatically load callbacks which passed in constructor as 
tasks</li>
</ul></div></div><div class="code"><div class="wrapper">        <span class="nx">loadSteps</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
        
    <span class="p">};</span>
    

    <span class="cm">/*</span>
<span class="cm">        @private loads steps from arguments</span>
<span class="cm">    */</span>
    <span class="kd">function</span> <span class="nx">loadSteps</span><span class="p">(</span><span class="nx">args</span><span class="p">){</span>

        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">&lt;</span> <span class="nx">args</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
            <span class="kd">var</span> <span class="nx">cur</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>

            <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">cur</span> <span class="o">!=</span> <span class="s2">&quot;function&quot;</span><span class="p">){</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">step</span><span class="p">(</span><span class="nx">cur</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">Rytm</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span>
  <span class="nx">p</span><span class="p">.</span><span class="nx">_createNode</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">next</span> <span class="o">===</span> <span class="nx">undef</span><span class="p">){</span>
      <span class="nx">next</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="p">{</span><span class="nx">callback</span><span class="o">:</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">next</span><span class="o">:</span> <span class="nx">next</span><span class="p">};</span>
    <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="beat">beat</h2>

<p>Add a callback to the execution sequence</p>

<h3 id="parameters">Parameters</h3>

<ul>
<li>callback: The task/callback to be added</li>
</ul>

<h3 id="tips-and-annotations">Tips and Annotations</h3></div></div><div class="code"><div class="wrapper">  <span class="nx">p</span><span class="p">.</span><span class="nx">beat</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">){</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">){</span>
            <span class="nx">loadSteps</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span><span class="p">{</span>
        <span class="kd">var</span> <span class="nx">stepStruct</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_createNode</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">steps</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">steps</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="nx">next</span> <span class="o">=</span> <span class="nx">stepStruct</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">steps</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">stepStruct</span><span class="p">);</span>
        </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ul>
<li>Once current Rytm instance executed
and after the execution of current instance
there are newly added tasks, go() will start
from previous stop point and work through the 
newly added task exclusively</li>
</ul></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">cursor</span> <span class="o">==</span> <span class="kc">null</span><span class="p">){</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">cursor</span> <span class="o">=</span> <span class="nx">stepStruct</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="p">}</span>
    
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="step">step</h2>

<p>An alias of <code>beat</code> for backward compatibility.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">p</span><span class="p">.</span><span class="nx">step</span> <span class="o">=</span> <span class="nx">beat</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="wait">wait</h2>

<p>When called, a built-in step will be added to the sequence for pausing
a specified millisecond</p>

<ul>
<li>wait: Specifiy the millisecond to wait.</li>
</ul></div></div><div class="code"><div class="wrapper">  <span class="nx">p</span><span class="p">.</span><span class="nx">wait</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">timeout</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="nx">s</span><span class="p">.</span><span class="nx">step</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
      <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">go</span><span class="p">,</span> <span class="nx">timeout</span><span class="p">);</span>
    <span class="p">});</span>
    
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="go">go</h2>

<p>A wrapper of <code>_go()</code> with bounded context. You can feel free to
call <code>go</code> or pass <code>go</code> to any async function as a callback method without
worrying the changing of context.</p>

<h3 id="usage">Usage</h3>

<pre><code>function asyncCall(callback){
    setTimeout(function(){
        callback.call({});
    }, 0)
}

(new Rytm(function(){
    // no worry, simply pass it to anything you want
    asyncCall(this.go);
})).go();
</code></pre></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="-go">_go</h2>

<p>When called, execute the next step immediately. (context-binding-free)</p>

<h3 id="tips-and-annotations">Tips and Annotations</h3></div></div><div class="code"><div class="wrapper">  <span class="nx">p</span><span class="p">.</span><span class="nx">_go</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
    
    <span class="kd">var</span> <span class="nx">callback</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">cursor</span> <span class="o">==</span> <span class="kc">null</span><span class="p">){</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="nx">callback</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">cursor</span><span class="p">.</span><span class="nx">callback</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ul>
<li><code>_go()</code> will internally setup/normalize the parameters </li>
</ul></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">cursor</span><span class="p">.</span><span class="nx">lastCalls</span> <span class="o">=</span> <span class="p">[];</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span> <span class="o">==</span> <span class="kc">null</span><span class="p">){</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">}</span>
    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>and then advance to next</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">cursor</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">cursor</span><span class="p">.</span><span class="nx">next</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">callback</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ul>
<li>_go() will also check if the <code>beat</code> has a return value
if there is, then consider the result as the parameter of
next <code>beat</code>
p.s. return false will also cause immediate execution of next
<code>beat</code></li>
</ul></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="nx">result</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">){</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">go</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
        <span class="p">}</span>
    
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="defer">defer</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="nx">p</span><span class="p">.</span><span class="nx">defer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">go</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="cm">/**</span>
<span class="cm">   * @function once</span>
<span class="cm">   * Return a callback, once the callback is called, go to next step and ignore </span>
<span class="cm">   * the other calls which defined in current step</span>
<span class="cm">   */</span>
  <span class="nx">p</span><span class="p">.</span><span class="nx">once</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">cur</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">cursor</span><span class="p">,</span>
      <span class="nx">go</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">go</span><span class="p">,</span>
      <span class="nx">scope</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="k">return</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">cur</span> <span class="o">!=</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">cursor</span><span class="p">){</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="nx">go</span><span class="p">();</span>
    <span class="p">};</span>
  <span class="p">};</span>

  <span class="cm">/**</span>
<span class="cm">     * @function all</span>
<span class="cm">     * Return a new callback each time last() is called, will go to next step once all generated callback is called</span>
<span class="cm">     * at least once.</span>
<span class="cm">     */</span>
    <span class="nx">p</span><span class="p">.</span><span class="nx">all</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="kd">var</span> <span class="nx">cur</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">cursor</span><span class="p">,</span>
            <span class="nx">go</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">go</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">cur</span><span class="p">){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>means we reached the end</p></div></div><div class="code"><div class="wrapper">          <span class="k">return</span> <span class="nx">noop</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">cur</span><span class="p">.</span><span class="nx">lastCalls</span><span class="p">){</span>
            <span class="nx">cur</span><span class="p">.</span><span class="nx">lastCalls</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">cur</span><span class="p">.</span><span class="nx">ticked</span> <span class="o">==</span> <span class="kc">null</span><span class="p">){</span>
            <span class="nx">cur</span><span class="p">.</span><span class="nx">ticked</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
                <span class="nx">cur</span><span class="p">.</span><span class="nx">ticked</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">},</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
            <span class="kd">var</span> <span class="nx">scope</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
                <span class="nx">args</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">;</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">cur</span><span class="p">.</span><span class="nx">ticked</span><span class="p">){</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if it is executed within the calling TASK, we delay the actual execution
to next TASK
this is to prevent a usage pitfall:
s.step(function(){
// this will cause problem
executeTheCallbackImmediately(s.all());
executeTheCallbackImmediately(s.all());</p></div></div><div class="code"><div class="wrapper">                <span class="c1">//})</span>
                <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
                    <span class="k">return</span> <span class="nx">ret</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
                <span class="p">},</span> <span class="mi">0</span><span class="p">);</span>

                <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="kd">var</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">lastCalls</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
            <span class="k">while</span><span class="p">(</span><span class="nx">l</span><span class="o">--</span><span class="p">){</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">cur</span><span class="p">.</span><span class="nx">lastCalls</span><span class="p">[</span><span class="nx">l</span><span class="p">]</span> <span class="o">==</span> <span class="nx">ret</span><span class="p">){</span>
                    <span class="nx">cur</span><span class="p">.</span><span class="nx">lastCalls</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">l</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">cur</span><span class="p">.</span><span class="nx">lastCalls</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">){</span>
                        <span class="nx">go</span><span class="p">();</span>
                    <span class="p">}</span>
                    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">};</span>

        <span class="nx">cur</span><span class="p">.</span><span class="nx">lastCalls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">ret</span><span class="p">);</span>
    
        <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span> 
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="todo">TODO</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="reverse">reverse</h3>

<h3 id="bounce">bounce</h3>

<p>If we are at the end, reverse the sequence and go</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="next">next</h3>

<p>Return next beat, next should be a getter/setter that allow</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="prev">prev</h3>

<p>Return prev beat</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="group">group</h3></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h3 id="dataparams">data/params</h3>

<p>To hold the parameters to next beat</p>

<h3 id="test">test</h3></div></div><div class="code"><div class="wrapper">  
  <span class="k">return</span> <span class="nx">Rytm</span><span class="p">;</span>
<span class="p">});</span></div></div></div></div></body></html>